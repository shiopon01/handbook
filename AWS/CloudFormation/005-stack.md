# スタック

ここでは、AWS CloudFormationがどのようにしてAWSリソースを管理しているのかを説明する。

CloudFormationはテキスト形式のテンプレートファイルからAWSリソースを生成するが、実際はテンプレートファイルやそこから作成されるAWSリソースを管理する概念として、 **スタック** と呼ばれるものが存在する。1つのスタックは1つのサンドボックスという認識でも問題ない。

スタックはCloudFormationが管理している一番大きな単位であり、1つのテンプレートファイルに対して1つのスタックが割り当てられる。スタックは対象のテンプレートを管理し、宣言されたAWSリソースを作成しながらスタックへの紐付けを行っていく。（AWSリソースを作成する段階でスタック内で発生したログ、イベントなども全てスタックが管理している。）

テンプレートに記述されたAWSリソースはこのスタックに紐付けられているため、変更・削除を行いたい場合はスタックで管理されているテンプレートに変更を加えることで紐付いたAWSリソースに影響を与えることができる。また、AWSリソースを削除する場合は、スタックを削除することで紐付くAWSリソースを全て削除することができる。

次の図は、テンプレートファイルからスタックを作成し、AWSリソースを作成するまでのイメージ。

![Stackイメージ](/img/aws-cf-stack-001.png "Stackイメージ")

1テンプレートファイル1スタックという決まりがあるが、1度のスタック作成で1つのスタックしか作成できないわけではない。

スタックには **ネスト** という機能が備わっていて、テンプレートから新しいスタックを作成することができる。この機能を使えば長くなりすぎたスタックを分割することができるほか、汎用的なテンプレートを作成しておくことでテンプレートの使い回しが利くようにもなる。（ネストに利用するテンプレートファイルは予めS3に保存しておく。）

次の図は、スタックをネストするイメージ。ここではネストしたスタックとして、 `Cognito UserPool` を作成するスタックと、 `Lambda Function` と `API Gateway RestAPI` を作成するスタックを作成している。また自らも、 `DynamoDB Table` を作成している。

![Nestイメージ](/img/aws-cf-stack-002.png "Nestイメージ")


