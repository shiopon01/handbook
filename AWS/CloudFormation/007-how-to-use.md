# AWS CloudFormationの使い方

AWS CloudFormationを利用するため、まず初めはスタックを作成するためのテンプレートを手に入れなけれる必要がある。テンプレートを入手する方法は大まかに3つだ。

1. AWSなどで公開されているサンプルテンプレートを使用する
2. クイックスタート（公式チュートリアル）で公開されているテンプレートを使用する
3. 自分でテンプレートを作成する
  - YAMLかJSON形式のテンプレートを作成する
  - CloudFormation Designerを利用する
  - CloudFormerを利用する

テンプレートを手に入れる方法は様々だが、まずはCloudFormationでスタックを作成することが目的のため、S3バケットを作成する最小のテンプレートを利用しよう。

```json
{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Resources": {
    "MyS3Bucket": {
      "Type": "AWS::S3::Bucket"
    }
  }
}
```

```yaml
AWSTemplateFormatVersion: 2010-09-09
Resources:
  MyS3Bucket:
    Type: AWS::S3::Bucket
```

`MyS3Bucket` 内に `"Properties": {"BucketName": ...` を含めることで作成するバケットの名前を指定することはできるが、ここでは指定せずAWSの自動生成に頼る。自動生成では `#{スタック名}-#{リソース名}-#{乱数}` の形式の名前が設定されるため、バケット名の重複がほとんどないためだ。

## スタックの作成

まず、CloudFormationのAWSマネジメントコンソールにある **スタックの作成** ボタンからスタック作成画面に移ろう。

![スタックの作成](/img/aws-cf-how-to-use-001.png "スタックの作成")

スタックの作成画面では色々出てくるが、難しいことはない。 `テンプレートをデザインする` では、 `AWS CloudFormation Designer` というツールを使って直感的に新規のテンプレートを作成することができる。 `テンプレートの選択` ではS3に保存したテンプレートファイルを指定してスタックを作成することができる。

S3に保存してあるテンプレートは無いので、ここでは **テンプレートのデザイン** ボタンから新規のテンプレートを作成するとしよう。

![スタックの作成2](/img/aws-cf-how-to-use-002.png "スタックの作成2")

`AWS CloudFormation Designer` はおなじみのAWSアイコンを繋げるだけでCloudFormationのテンプレートを作成できるというAWSのツールだ。（だが実際のところ、アイコンを繋げてテンプレートを作成することは、無い。）

![スタックの作成3](/img/aws-cf-how-to-use-003.png "スタックの作成3")

このツールではアイコンを繋げてテンプレートを作るだけでなく、自分のテンプレートを記述できる機能もある。（こちらがメイン。）画面左下のタブ `テンプレート` をクリックすると、テキストエリアが自分のテンプレートを記述するためのテキストエリアに切り替わる。

`テンプレートの言語の選択` で選択されているのはJSONだが、今回はそこにYAMLのテンプレートを貼り付けてみよう。

```yaml
AWSTemplateFormatVersion: 2010-09-09
Resources:
  MyS3Bucket:
    Type: AWS::S3::Bucket
```

![スタックの作成4](/img/aws-cf-how-to-use-004.png "スタックの作成4")

実は `テンプレートの言語の選択` がJSONでこのスペースにYAMLのテンプレートを貼り付けた場合、自動的にYAMLのラジオボタンが選択される。（つまり、この部分はあまり気にしなくても良い。）構文エラーのYAMLのテンプレートを貼り付けた場合は正常に切り替わらないので注意。

ここまで進むと、グラフ部分には `Designerが最新のものではないので、リフレッシュをクリックしてください。` という警告文が表示されるので、 **リフレッシュ** （右上の矢印が回っているマーク）をクリックしてグラフを更新しよう。

![スタックの作成5](/img/aws-cf-how-to-use-005.png "スタックの作成5")

グラフには1つのS3バケットと思われるアイコンが出現する。太字で `MyS3Bucket` とリソース名が書かれているので、これはテンプレートで宣言したS3バケットで間違いない。

さて、これで `AWS CloudFormation Designer` での作業は終わりだ。新しいテンプレートの作成を確定するため、 **スタックの作成** （左上の雲に↑が書いてあるマーク）のボタンを押す。ここで作成されたテンプレートは、自分のアカウントの、CloudFormationによって自動生成されたS3バケットに保存される。

リダイレクトとローディングの後、画面は `AWS CloudFormation Designer` を利用する前の、スタックの作成画面に戻される。唯一違う点は、 `Amazon S3 テンプレートURLの指定` にURLが設定されていることだ。これはさっき作成したテンプレートファイルを指している。 **次へ** 。

![スタックの作成6](/img/aws-cf-how-to-use-006.png "スタックの作成6")
